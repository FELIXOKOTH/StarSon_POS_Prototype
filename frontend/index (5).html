<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StarSon POS</title>
  <link rel="stylesheet" href="css/starson.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #product-list, #cart, #receipt-preview { margin-bottom: 20px; }
    .flex { display: flex; gap: 10px; align-items: center; }
    .split-group { margin-top: 10px; }
    .split-group input { width: 100px; }
  </style>
</head>
<body>

  <h1>StarSon POS</h1>

  <div id="product-list"></div>

  <div id="cart"></div>

  <div class="flex">
    <label for="payment-method">Payment Method:</label>
    <select id="payment-method" onchange="toggleSplit()">
      <option value="Cash">Cash</option>
      <option value="Mpesa">Mpesa</option>
      <option value="Card">Card</option>
      <option value="mixed">Mixed</option>
    </select>
  </div>

  <div id="split-payment-fields" style="display:none;">
    <div class="split-group">
      <label>Cash:</label> <input type="number" id="split-cash" oninput="updateRemaining()" min="0">
    </div>
    <div class="split-group">
      <label>Mpesa:</label> <input type="number" id="split-mpesa" oninput="updateRemaining()" min="0">
    </div>
    <div class="split-group">
      <label>Card:</label> <input type="number" id="split-card" oninput="updateRemaining()" min="0">
    </div>
    <p><strong>Remaining Balance:</strong> <span id="remaining-balance">0</span></p>
  </div>

  <button onclick="checkout()">Checkout</button>

  <div id="receipt-preview" style="display:none;">
    <h3>Receipt</h3>
    <div id="receipt-summary"></div>
    <p><img id="receipt-qr-img" /></p>
    <p id="tree-saving"></p>
    <button onclick="downloadPDF()">Download PDF</button>
  </div>

  <script>
    let cart = [];
    let total = 0;

    async function fetchProducts() {
      const res = await fetch("/products");
      const data = await res.json();
      const list = document.getElementById("product-list");
      list.innerHTML = "<h3>Products</h3>";
      data.forEach(product => {
        const item = document.createElement("div");
        item.classList.add("flex");
        item.innerHTML = `<span>${product.name} (KES ${product.price})</span>
                          <button onclick="addToCart('${product.id}')">Add</button>`;
        list.appendChild(item);
      });
    }

    function addToCart(id) {
      fetch("/products")
        .then(res => res.json())
        .then(products => {
          const product = products.find(p => p.id === id);
          const existing = cart.find(item => item.id === id);
          if (existing) existing.qty++;
          else cart.push({ ...product, qty: 1 });
          updateCartDisplay();
        });
    }

    function updateCartDisplay() {
      const cartDiv = document.getElementById("cart");
      cartDiv.innerHTML = "<h3>Cart</h3>";
      total = 0;
      cart.forEach(item => {
        const subtotal = item.qty * item.price;
        total += subtotal;
        const div = document.createElement("div");
        div.innerHTML = `<span>${item.name} x${item.qty}</span>
                         <span>KES ${subtotal}</span>`;
        cartDiv.appendChild(div);
      });
      updateRemaining();
    }

    function toggleSplit() {
      const method = document.getElementById("payment-method").value;
      document.getElementById("split-payment-fields").style.display = method === "mixed" ? "block" : "none";
      updateRemaining();
    }

    function updateRemaining() {
      if (document.getElementById("payment-method").value !== "mixed") return;
      const cash = parseFloat(document.getElementById("split-cash").value || 0);
      const mpesa = parseFloat(document.getElementById("split-mpesa").value || 0);
      const card = parseFloat(document.getElementById("split-card").value || 0);
      const paid = cash + mpesa + card;
      const remaining = (total - paid).toFixed(2);
      document.getElementById("remaining-balance").textContent = remaining >= 0 ? remaining : "0";
    }

    function checkout() {
      const method = document.getElementById("payment-method").value;
      let paymentData = method;
      if (method === "mixed") {
        paymentData = {
          method: "mixed",
          cash: parseFloat(document.getElementById("split-cash").value || 0),
          mpesa: parseFloat(document.getElementById("split-mpesa").value || 0),
          card: parseFloat(document.getElementById("split-card").value || 0),
        };
      }

      fetch("/generate_receipt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items: cart, paymentMethod: paymentData })
      })
      .then(res => res.json())
      .then(data => {
        const preview = document.getElementById("receipt-preview");
        const summary = document.getElementById("receipt-summary");
        preview.style.display = "block";
        summary.innerHTML = `
          <p><strong>Transaction ID:</strong> ${data.receipt_id}</p>
          <p><strong>Payment:</strong> ${JSON.stringify(data.payment_method)}</p>
          <ul>${data.items.map(i => `<li>${i.name} x${i.qty} - KES ${i.qty * i.price}</li>`).join('')}</ul>
          <p><strong>Total:</strong> KES ${data.total}</p>`;
        document.getElementById("receipt-qr-img").src = data.qr_img;
        document.getElementById("tree-saving").textContent = `ðŸŽ‹ You saved ~1/8500 of a tree ðŸŒ³!`;
      });
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(document.getElementById("receipt-summary").innerText, 10, 10);
      doc.save("receipt.pdf");
    }

    fetchProducts();
  </script>

</body>
</html>

