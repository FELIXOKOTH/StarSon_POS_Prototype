<!-- ðŸ“± StarSon POS | Auto STK Push Payment Trigger -->
<div id="payment-section" style="display:none;">
  <h2>Processing Payment...</h2>
  <form id="paymentForm">
    <!-- Auto-populated via JS -->
    <input type="hidden" id="phone" name="phone" />
    <input type="hidden" id="amount" name="amount" />
    <button type="submit" style="display:none;">Pay via STK</button>
  </form>
</div>

<script>
// Trigger STK Payment from cart or checkout
function triggerSTKPayment(customerPhone, totalAmount) {
  document.getElementById("phone").value = customerPhone;
  document.getElementById("amount").value = totalAmount;

  const paymentSection = document.getElementById("payment-section");
  paymentSection.style.display = "block"; // show processing

  const form = document.getElementById("paymentForm");
  form.dispatchEvent(new Event('submit'));
}

// Handle STK Push Submission
document.getElementById("paymentForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const phone = document.getElementById("phone").value;
  const amount = document.getElementById("amount").value;

  if (!phone || !amount) {
    alert("Missing phone number or amount.");
    return;
  }

  try {
    const response = await fetch('/initiate_payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        phone: phone,
        amount: amount,
        account_ref: 'StarSonPOS'
      })
    });

    const result = await response.json();
    alert(result.ResponseDescription || 'Payment request sent.');
